<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>存量收回再贷重定价测算小工具（无库版）</title>
    <style>
        :root{
            --bg:#0b0d10;
            --card:#12151b;
            --muted:#9aa4b2;
            --text:#e7edf6;
            --line:#202734;
            --ok:#22c55e;
            --warn:#f59e0b;
            --bad:#ef4444;
            --btn:#1f2937;
            --btn2:#111827;
            --chip:#0f172a;
            --shadow: 0 10px 30px rgba(0,0,0,.35);
            --r:14px;
            --pad:16px;
        }
        body{
            margin:0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC","Microsoft YaHei", Arial;
            background: radial-gradient(1200px 600px at 20% 0%, #111827 0%, var(--bg) 60%);
            color: var(--text);
        }
        header{
            padding: 18px 18px 8px;
            max-width: 1100px;
            margin: 0 auto;
        }
        h1{
            margin:0 0 6px;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: .2px;
        }
        .sub{
            margin:0;
            color: var(--muted);
            font-size: 13px;
            line-height: 1.6;
        }
        .wrap{
            max-width: 1100px;
            margin: 10px auto 30px;
            padding: 0 18px;
            display: grid;
            grid-template-columns: 1.15fr .85fr;
            gap: 14px;
        }
        .card{
            background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
            border: 1px solid var(--line);
            border-radius: var(--r);
            box-shadow: var(--shadow);
            overflow:hidden;
        }
        .card .hd{
            padding: 14px 16px;
            border-bottom: 1px solid var(--line);
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap: 10px;
        }
        .card .hd b{ font-size:14px; }
        .card .bd{ padding: 16px; }
        .grid{
            display:grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .field label{
            display:block;
            font-size: 12px;
            color: var(--muted);
            margin: 0 0 6px;
        }
        .field input, .field select{
            width:100%;
            box-sizing:border-box;
            padding: 10px 10px;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: rgba(0,0,0,.25);
            color: var(--text);
            outline: none;
        }
        .field input::placeholder{ color: rgba(154,164,178,.6); }
        .row{
            display:flex;
            gap:10px;
            flex-wrap:wrap;
            align-items:center;
        }
        .btn{
            cursor:pointer;
            border: 1px solid var(--line);
            background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
            color: var(--text);
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 13px;
        }
        .btn:hover{ border-color: rgba(255,255,255,.18); }
        .btn.primary{
            background: linear-gradient(180deg, rgba(34,197,94,.18), rgba(34,197,94,.06));
            border-color: rgba(34,197,94,.35);
        }
        .btn.danger{
            background: linear-gradient(180deg, rgba(239,68,68,.18), rgba(239,68,68,.06));
            border-color: rgba(239,68,68,.35);
        }
        .hint{
            font-size: 12px;
            color: var(--muted);
            line-height: 1.6;
            margin-top: 8px;
        }
        .chips{
            display:flex;
            gap:8px;
            flex-wrap:wrap;
            margin-top: 8px;
        }
        .chip{
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid var(--line);
            background: rgba(0,0,0,.25);
            font-size: 12px;
            color: var(--muted);
        }
        .big{
            font-size: 30px;
            font-weight: 800;
            letter-spacing: .2px;
        }
        .kpi{
            display:grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .kpi .box{
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 10px 12px;
            background: rgba(0,0,0,.22);
        }
        .kpi .box .t{ font-size: 12px; color: var(--muted); }
        .kpi .box .v{ font-size: 16px; font-weight: 700; margin-top: 4px; }
        .badge{
            display:inline-flex;
            align-items:center;
            gap:6px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            border:1px solid var(--line);
            background: rgba(0,0,0,.25);
            color: var(--muted);
        }
        .badge.ok{ color: var(--ok); border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.08); }
        .badge.warn{ color: var(--warn); border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.08); }
        .badge.bad{ color: var(--bad); border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.08); }
        .mono{
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            color: #c9d4e3;
            white-space: pre-wrap;
            background: rgba(0,0,0,.25);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 12px;
            line-height: 1.6;
        }
        canvas{
            width: 100%;
            height: 160px;
            border: 1px solid var(--line);
            border-radius: 12px;
            background: rgba(0,0,0,.18);
        }
        .table{
            width:100%;
            border-collapse: collapse;
            font-size: 12px;
            color: var(--muted);
        }
        .table th, .table td{
            padding: 8px 6px;
            border-bottom: 1px dashed rgba(255,255,255,.08);
            text-align:left;
        }
        .table th{ color: #cbd5e1; font-weight: 700; }
        .small{ font-size: 12px; color: var(--muted); }
        @media (max-width: 980px){
            .wrap{ grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<header>
    <h1>存量收回再贷重定价测算小工具（无库版）</h1>
    <p class="sub">
        仅本机计算、不上传、不建库。产品最低利率默认取“区间左侧”（如 7.00–10.30 取 7.00）。<br>
        三种情形：①原利率≥最低利率；②原利率&lt;最低利率但不走三条件；③原利率&lt;最低利率且三条件判断（逾期/归行率/负面信息）→ 可能加点重定价。
    </p>
</header>

<div class="wrap">
    <!-- 左：输入 -->
    <section class="card">
        <div class="hd">
            <b>输入（可编辑表单）</b>
            <span class="badge" id="statusBadge">等待计算</span>
        </div>
        <div class="bd">
            <div class="grid">
                <div class="field">
                    <label>信贷产品分类</label>
                    <select id="product"></select>
                </div>

                <div class="field">
                    <label>担保方式</label>
                    <select id="guarantee"></select>
                </div>

                <div class="field">
                    <label>授信额度（万元）</label>
                    <input id="amount" type="number" step="0.01" min="0" placeholder="例如：30 / 70 / 150" />
                </div>

                <div class="field">
                    <label>授信期限（个月）</label>
                    <input id="termMonths" type="number" step="1" min="1" placeholder="例如：12 / 36" />
                </div>

                <div class="field">
                    <label>产品最低执行利率（自动带出）</label>
                    <input id="minRate" type="number" step="0.01" min="0" disabled />
                </div>

                <div class="field">
                    <label>原合同/当前利率 origRate（%）</label>
                    <input id="origRate" type="number" step="0.01" min="0" placeholder="可手动修改" />
                </div>
            </div>

            <div class="chips" id="caseChips"></div>

            <div style="height:10px"></div>
            <div class="card" style="box-shadow:none; border-radius:12px;">
                <div class="hd" style="border-bottom:1px solid rgba(255,255,255,.06);">
                    <b>情形③（仅当 原利率 &lt; 最低利率 时考虑）</b>
                    <span class="small">三条件输入</span>
                </div>
                <div class="bd">
                    <div class="grid">
                        <div class="field">
                            <label>近一年逾期次数（默认 0）</label>
                            <input id="overdueCount" type="number" step="1" min="0" value="0" />
                        </div>

                        <div class="field">
                            <label>资金归行率（%）（阈值 8%）</label>
                            <input id="fundRate" type="number" step="0.01" min="0" placeholder="例如：8 / 6.5" />
                        </div>

                        <div class="field">
                            <label>互联网负面信息</label>
                            <select id="negativeInfo">
                                <option value="无">无</option>
                                <option value="有">有</option>
                            </select>
                        </div>

                        <div class="field">
                            <label>拟执行利率 execRate（%）</label>
                            <input id="execRate" type="number" step="0.01" min="0" placeholder="计算后可手动改" />
                        </div>
                    </div>

                    <div class="row" style="margin-top:10px;">
                        <button class="btn primary" id="btnCalc">计算/刷新结果</button>
                        <button class="btn" id="btnSave">保存到本机历史</button>
                        <button class="btn" id="btnExportCSV">导出CSV（历史）</button>
                        <button class="btn" id="btnExportPNG">导出PNG（结果摘要）</button>
                        <button class="btn danger" id="btnClearHistory">清空本机历史</button>
                    </div>

                    <p class="hint">
                        说明：本工具不上传任何数据；“本机历史”保存在浏览器 localStorage，可随时清空。<br>
                        BP 换算：10BP=0.10%，100BP=1.00%。
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- 右：输出 -->
    <section class="card">
        <div class="hd">
            <b>输出（对比 + 过程）</b>
            <span class="badge" id="approvalBadge">—</span>
        </div>
        <div class="bd" id="resultArea">
            <div class="big" id="finalRateText">—</div>
            <div class="small" style="margin-top:6px;" id="finalDesc">请输入必要信息并点击计算。</div>

            <div class="kpi">
                <div class="box">
                    <div class="t">原利率 origRate（%）</div>
                    <div class="v" id="kpiOrig">—</div>
                </div>
                <div class="box">
                    <div class="t">最低利率 minRate（%）</div>
                    <div class="v" id="kpiMin">—</div>
                </div>
                <div class="box">
                    <div class="t">重定价利率 repriceRate（%）</div>
                    <div class="v" id="kpiReprice">—</div>
                </div>
                <div class="box">
                    <div class="t">建议执行利率 execRate（%）</div>
                    <div class="v" id="kpiExec">—</div>
                </div>
            </div>

            <div style="height:12px"></div>
            <canvas id="chart" width="640" height="180"></canvas>

            <div style="height:12px"></div>
            <div class="mono" id="processText">（计算过程将在这里显示）</div>

            <div style="height:14px"></div>
            <b style="font-size: 13px;">本机历史（最近 10 条预览）</b>
            <div style="height:8px"></div>
            <table class="table" id="historyTable">
                <thead>
                <tr>
                    <th>时间</th>
                    <th>产品</th>
                    <th>额度</th>
                    <th>期限</th>
                    <th>orig</th>
                    <th>min</th>
                    <th>exec</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>
</div>

<script>
    /**
     * =========================
     *  1) 产品最低利率配置表（请按你们“大表”填）
     * =========================
     * 结构：每条规则包含：
     * - product: 产品分类
     * - guarantee: 担保方式
     * - amountMin/amountMax: 额度区间（万元），max 可用 null 表示无上限
     * - termMin/termMax: 期限区间（月），max 可用 null
     * - minRate: 最低利率（%）——只填“区间左侧”
     *
     * 你可以先把最常用的几条填进去，跑通再补全。
     */
    const RATE_TABLE = [
        // ===== 示例（请替换成你们真实数据） =====
        { product: "惠农贷", guarantee: "保证", amountMin: 30, amountMax: 100, termMin: 1, termMax: 36, minRate: 7.00 },
        { product: "惠农贷", guarantee: "保证", amountMin: 100, amountMax: null, termMin: 1, termMax: 36, minRate: 7.50 },
        { product: "惠农贷", guarantee: "信用", amountMin: 30, amountMax: null, termMin: 1, termMax: 36, minRate: 7.00 },

        { product: "助赢贷", guarantee: "保证", amountMin: 50, amountMax: 100, termMin: 1, termMax: 36, minRate: 6.50 },
        { product: "助赢贷", guarantee: "保证", amountMin: 100, amountMax: 200, termMin: 1, termMax: 36, minRate: 7.00 },

        { product: "原押快贷", guarantee: "抵押", amountMin: 0, amountMax: null, termMin: 1, termMax: 36, minRate: 3.45 },

        // 你继续在这里追加...
    ];

    const PRODUCTS = Array.from(new Set(RATE_TABLE.map(r => r.product))).sort();
    const GUARANTEES = Array.from(new Set(RATE_TABLE.map(r => r.guarantee))).sort();

    /**
     * =========================
     *  2) 业务规则：BP / 三情形判断 / 加点重定价
     * =========================
     */
    function bpToPct(bp){
        // 10BP = 0.10% => bp/100
        return bp / 100;
    }

    function round2(n){
        if (n === null || n === undefined || Number.isNaN(n)) return null;
        return Math.round(n * 100) / 100;
    }

    function matchRange(val, min, max){
        if (val === null || val === undefined || Number.isNaN(val)) return false;
        if (val < min) return false;
        if (max === null) return true;
        return val <= max;
    }

    function findMinRate(product, guarantee, amount, termMonths){
        // 找“最匹配的一条”。这里用“第一条匹配”的方式；
        // 如果你担心重叠规则，可改成更严格的优先级（比如范围更窄优先）。
        const hits = RATE_TABLE.filter(r =>
            r.product === product &&
            r.guarantee === guarantee &&
            matchRange(amount, r.amountMin, r.amountMax) &&
            matchRange(termMonths, r.termMin, r.termMax)
        );
        if (!hits.length) return null;

        // 优先选“范围更窄”的（更具体）
        hits.sort((a,b)=>{
            const aSpan = (a.amountMax ?? 1e9) - a.amountMin + ((a.termMax ?? 1e9) - a.termMin)/1e6;
            const bSpan = (b.amountMax ?? 1e9) - b.amountMin + ((b.termMax ?? 1e9) - b.termMin)/1e6;
            return aSpan - bSpan;
        });
        return hits[0].minRate;
    }

    function calcScenario(input){
        const {
            product, guarantee, amount, termMonths,
            minRate, origRate,
            overdueCount, fundRate, negativeInfo
        } = input;

        const process = [];
        let approvalText = "不需上报定价审批";
        let approvalLevel = "ok";

        process.push(`【基础】产品=${product}；担保=${guarantee}；额度=${amount}万；期限=${termMonths}月`);
        process.push(`【取值】最低执行利率 minRate = ${minRate}%（取利率区间左侧）`);
        process.push(`【输入】原利率 origRate = ${origRate}%`);

        let caseNo = "";
        let addBP = 0;
        let repriceRate = null;
        let execRate = null;

        if (origRate >= minRate){
            caseNo = "① 原利率 ≥ 最低利率";
            execRate = origRate; // 默认建议不降
            process.push(`【情形①】origRate(${origRate}) ≥ minRate(${minRate}) → 建议执行=原利率（或更高）`);
        } else {
            // origRate < minRate
            process.push(`【分支】origRate(${origRate}) < minRate(${minRate}) → 进入情形②/③判断`);

            // 三条件是否满足
            const okOverdue = (overdueCount === 0);
            const okFund = (fundRate !== null && !Number.isNaN(fundRate) && fundRate >= 8);
            const okNeg = (negativeInfo === "无");

            process.push(`【三条件】近一年逾期次数=${overdueCount} → ${okOverdue ? "满足(=0)" : "不满足(>0)"}`);
            process.push(`【三条件】资金归行率=${fundRate}%（阈值8%）→ ${okFund ? "满足" : "不满足"}`);
            process.push(`【三条件】互联网负面信息=${negativeInfo} → ${okNeg ? "满足(无)" : "不满足(有)"}`);

            const allOk = okOverdue && okFund && okNeg;

            if (allOk){
                caseNo = "③A 原利率 < 最低利率 且三条件满足";
                execRate = origRate; // 允许执行原利率
                process.push(`【情形③A】三条件全部满足 → 允许执行原利率（或更高）`);
                process.push(`【结果】execRate = origRate = ${execRate}%`);
            } else {
                caseNo = "③B 原利率 < 最低利率 且三条件不满足 → 加点重定价";
                addBP = 10;
                if (!okFund) addBP += 10;
                if (!okNeg) addBP += 10;
                if (addBP > 30) addBP = 30;

                process.push(`【加点规则】基础+10BP；归行率不足8%再+10BP；有负面信息再+10BP；封顶30BP`);
                process.push(`【加点结果】addBP = ${addBP}BP（10BP=0.10%）`);

                repriceRate = round2(origRate + bpToPct(addBP));
                process.push(`【重定价】repriceRate = origRate + addBP = ${origRate}% + ${(bpToPct(addBP)).toFixed(2)}% = ${repriceRate}%`);

                // 稳妥：执行利率不能低于产品底线
                execRate = Math.max(repriceRate, minRate);
                execRate = round2(execRate);

                process.push(`【底线校验】execRate = max(repriceRate, minRate) = max(${repriceRate}, ${minRate}) = ${execRate}%`);
                process.push(`【提示】执行重定价利率或更高 → 不需上报定价审批（按制度口径）`);
            }
        }

        return {
            caseNo,
            approvalText,
            approvalLevel,
            addBP,
            repriceRate,
            execRate,
            processText: process.join("\n")
        };
    }

    /**
     * =========================
     *  3) 本机历史：localStorage
     * =========================
     */
    const LS_KEY = "reprice_calc_history_v1";
    const MAX_HISTORY = 100;

    function loadHistory(){
        try{
            const raw = localStorage.getItem(LS_KEY);
            if(!raw) return [];
            const arr = JSON.parse(raw);
            return Array.isArray(arr) ? arr : [];
        } catch(e){
            return [];
        }
    }

    function saveHistory(arr){
        localStorage.setItem(LS_KEY, JSON.stringify(arr.slice(0, MAX_HISTORY)));
    }

    function addHistory(item){
        const arr = loadHistory();
        arr.unshift(item);
        saveHistory(arr);
    }

    /**
     * =========================
     *  4) 导出 CSV（历史）
     * =========================
     */
    function exportHistoryCSV(){
        const arr = loadHistory();
        if(!arr.length){
            alert("本机历史为空。");
            return;
        }
        const headers = [
            "时间","产品","担保","额度(万)","期限(月)",
            "minRate(%)","origRate(%)","逾期次数","归行率(%)","负面信息",
            "情形","addBP","repriceRate(%)","execRate(%)"
        ];
        const rows = arr.map(x => [
            x.ts, x.product, x.guarantee, x.amount, x.termMonths,
            x.minRate, x.origRate, x.overdueCount, x.fundRate, x.negativeInfo,
            x.caseNo, x.addBP, x.repriceRate ?? "", x.execRate
        ].map(v => `"${String(v).replaceAll('"','""')}"`).join(","));

        const csv = headers.join(",") + "\n" + rows.join("\n");
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `重定价测算历史_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    /**
     * =========================
     *  5) 导出 PNG（结果摘要卡片，无第三方库）
     * =========================
     */
    function exportResultPNG(summary){
        // 用 canvas 画一张“摘要卡片”，避免引入 html2canvas
        const w = 1100, h = 620;
        const c = document.createElement("canvas");
        c.width = w; c.height = h;
        const g = c.getContext("2d");

        // 背景
        g.fillStyle = "#0b0d10";
        g.fillRect(0,0,w,h);

        // 卡片
        const x=40,y=40,cw=w-80,ch=h-80,r=18;
        g.fillStyle = "#12151b";
        roundRect(g, x,y,cw,ch,r, true, false);

        g.strokeStyle = "rgba(255,255,255,0.10)";
        g.lineWidth = 2;
        roundRect(g, x,y,cw,ch,r, false, true);

        // 标题
        g.fillStyle = "#e7edf6";
        g.font = "bold 34px ui-sans-serif,system-ui";
        g.fillText("存量收回再贷重定价测算结果摘要", x+28, y+58);

        // 基本信息
        g.font = "14px ui-sans-serif,system-ui";
        g.fillStyle = "rgba(231,237,246,0.75)";
        const info1 = `产品：${summary.product}   担保：${summary.guarantee}   额度：${summary.amount}万   期限：${summary.termMonths}月`;
        g.fillText(info1, x+28, y+90);

        // 大结果
        g.fillStyle = "#e7edf6";
        g.font = "bold 60px ui-sans-serif,system-ui";
        g.fillText(`建议执行：${summary.execRate}%`, x+28, y+170);

        // badge
        g.font = "bold 18px ui-sans-serif,system-ui";
        const badgeText = summary.approvalText;
        const bx = x+28, by = y+190, bw = 260, bh = 42;
        g.fillStyle = "rgba(34,197,94,0.12)";
        g.strokeStyle = "rgba(34,197,94,0.35)";
        roundRect(g, bx, by, bw, bh, 16, true, true);
        g.fillStyle = "#22c55e";
        g.fillText(badgeText, bx+16, by+28);

        // 四个 KPI
        const kx=x+28, ky=y+260, kw=(cw-56-18)/2, kh=92;
        drawKPI(g, kx, ky, kw, kh, "origRate", `${summary.origRate}%`);
        drawKPI(g, kx+kw+18, ky, kw, kh, "minRate", `${summary.minRate}%`);
        drawKPI(g, kx, ky+kh+18, kw, kh, "repriceRate", `${summary.repriceRate ?? "—"}${summary.repriceRate!=null?"%":""}`);
        drawKPI(g, kx+kw+18, ky+kh+18, kw, kh, "execRate", `${summary.execRate}%`);

        // 情形 + 加点
        g.fillStyle = "rgba(231,237,246,0.85)";
        g.font = "bold 18px ui-sans-serif,system-ui";
        g.fillText(`情形：${summary.caseNo}`, x+28, y+500);
        g.font = "14px ui-sans-serif,system-ui";
        g.fillStyle = "rgba(231,237,246,0.65)";
        g.fillText(`加点：${summary.addBP}BP（10BP=0.10%）   时间：${summary.ts}`, x+28, y+530);

        // 过程（截断）
        g.fillStyle = "rgba(231,237,246,0.55)";
        g.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
        const lines = (summary.processText || "").split("\n").slice(0, 8);
        let py = y+560;
        for(const line of lines){
            g.fillText(line.slice(0, 120), x+28, py);
            py += 16;
        }
        g.fillText("（过程仅展示前8行，可导出CSV查看完整记录）", x+28, py+6);

        const url = c.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = url;
        a.download = `重定价测算摘要_${new Date().toISOString().slice(0,19).replaceAll(":","-")}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();

        function roundRect(ctx, x, y, w, h, r, fill, stroke){
            ctx.beginPath();
            ctx.moveTo(x+r, y);
            ctx.arcTo(x+w, y, x+w, y+h, r);
            ctx.arcTo(x+w, y+h, x, y+h, r);
            ctx.arcTo(x, y+h, x, y, r);
            ctx.arcTo(x, y, x+w, y, r);
            ctx.closePath();
            if(fill) ctx.fill();
            if(stroke) ctx.stroke();
        }
        function drawKPI(ctx, x, y, w, h, title, value){
            ctx.fillStyle = "rgba(0,0,0,0.25)";
            ctx.strokeStyle = "rgba(255,255,255,0.10)";
            ctx.lineWidth = 1.5;
            roundRect(ctx, x,y,w,h, 16, true, true);
            ctx.fillStyle = "rgba(231,237,246,0.65)";
            ctx.font = "12px ui-sans-serif,system-ui";
            ctx.fillText(title, x+14, y+26);
            ctx.fillStyle = "#e7edf6";
            ctx.font = "bold 26px ui-sans-serif,system-ui";
            ctx.fillText(value, x+14, y+64);
        }
    }

    /**
     * =========================
     *  6) UI 绑定与渲染
     * =========================
     */
    const $ = (id) => document.getElementById(id);

    function initSelectors(){
        const productSel = $("product");
        productSel.innerHTML = PRODUCTS.map(p => `<option value="${p}">${p}</option>`).join("");

        const gSel = $("guarantee");
        gSel.innerHTML = GUARANTEES.map(g => `<option value="${g}">${g}</option>`).join("");
    }

    function setBadge(el, text, level){
        el.textContent = text;
        el.className = "badge";
        if(level) el.classList.add(level);
    }

    function renderChips(items){
        const box = $("caseChips");
        box.innerHTML = "";
        items.forEach(t=>{
            const s=document.createElement("span");
            s.className="chip";
            s.textContent=t;
            box.appendChild(s);
        });
    }

    function drawBarChart(values){
        // values: [{label, value, show}]
        const canvas = $("chart");
        const ctx = canvas.getContext("2d");
        const W = canvas.width, H = canvas.height;

        // 清空
        ctx.clearRect(0,0,W,H);

        // 背景
        ctx.fillStyle = "rgba(0,0,0,0.18)";
        ctx.fillRect(0,0,W,H);

        const data = values.filter(v => v.show && v.value !== null && !Number.isNaN(v.value));
        if(!data.length){
            ctx.fillStyle = "rgba(231,237,246,0.6)";
            ctx.font = "14px ui-sans-serif,system-ui";
            ctx.fillText("暂无可视化数据（请先计算）", 16, 28);
            return;
        }

        const maxV = Math.max(...data.map(d => d.value)) * 1.15;
        const minV = Math.min(...data.map(d => d.value)) * 0.85;

        const pad = 18;
        const barW = (W - pad*2) / data.length * 0.62;
        const gap = (W - pad*2) / data.length * 0.38;

        // 轴/刻度（简化）
        ctx.strokeStyle = "rgba(255,255,255,0.08)";
        ctx.beginPath();
        ctx.moveTo(pad, H-34);
        ctx.lineTo(W-pad, H-34);
        ctx.stroke();

        data.forEach((d,i)=>{
            const x = pad + i*(barW+gap) + gap*0.5;
            const norm = (d.value - minV) / (maxV - minV || 1);
            const bh = Math.max(6, norm * (H-70));
            const y = (H-34) - bh;

            // bar
            ctx.fillStyle = "rgba(231,237,246,0.75)";
            ctx.fillRect(x, y, barW, bh);

            // value
            ctx.fillStyle = "rgba(231,237,246,0.9)";
            ctx.font = "12px ui-sans-serif,system-ui";
            ctx.fillText(d.value.toFixed(2) + "%", x, y-8);

            // label
            ctx.fillStyle = "rgba(231,237,246,0.55)";
            ctx.fillText(d.label, x, H-14);
        });
    }

    function renderHistoryPreview(){
        const arr = loadHistory();
        const tbody = $("historyTable").querySelector("tbody");
        tbody.innerHTML = "";
        arr.slice(0,10).forEach(x=>{
            const tr = document.createElement("tr");
            tr.innerHTML = `
      <td>${x.ts}</td>
      <td>${x.product}</td>
      <td>${x.amount}</td>
      <td>${x.termMonths}</td>
      <td>${x.origRate}</td>
      <td>${x.minRate}</td>
      <td>${x.execRate}</td>
    `;
            tbody.appendChild(tr);
        });
    }

    function readInput(){
        const product = $("product").value;
        const guarantee = $("guarantee").value;
        const amount = Number($("amount").value);
        const termMonths = Number($("termMonths").value);

        const minRate = Number($("minRate").value);
        const origRate = Number($("origRate").value);

        const overdueCount = Number($("overdueCount").value || 0);
        const fundRateVal = $("fundRate").value;
        const fundRate = fundRateVal === "" ? null : Number(fundRateVal);
        const negativeInfo = $("negativeInfo").value;

        const execRateVal = $("execRate").value;
        const execRateManual = execRateVal === "" ? null : Number(execRateVal);

        return {
            product, guarantee,
            amount: Number.isNaN(amount) ? null : amount,
            termMonths: Number.isNaN(termMonths) ? null : termMonths,
            minRate: Number.isNaN(minRate) ? null : minRate,
            origRate: Number.isNaN(origRate) ? null : origRate,
            overdueCount: Number.isNaN(overdueCount) ? 0 : overdueCount,
            fundRate: (fundRate === null || Number.isNaN(fundRate)) ? null : fundRate,
            negativeInfo,
            execRateManual: (execRateManual === null || Number.isNaN(execRateManual)) ? null : execRateManual
        };
    }

    function validateBasic(input){
        const miss = [];
        if(!input.product) miss.push("产品");
        if(!input.guarantee) miss.push("担保方式");
        if(input.amount === null) miss.push("额度");
        if(input.termMonths === null) miss.push("期限(月)");
        if(input.minRate === null) miss.push("最低利率");
        if(input.origRate === null) miss.push("原利率");
        return miss;
    }

    function refreshMinRate(){
        const product = $("product").value;
        const guarantee = $("guarantee").value;
        const amount = Number($("amount").value);
        const termMonths = Number($("termMonths").value);

        const minRate = findMinRate(
            product,
            guarantee,
            Number.isNaN(amount) ? null : amount,
            Number.isNaN(termMonths) ? null : termMonths
        );

        $("minRate").value = (minRate === null ? "" : minRate);
        // origRate 默认跟随 minRate（但只在 origRate 为空时填充，避免覆盖用户手改）
        if($("origRate").value === "" && minRate !== null){
            $("origRate").value = minRate;
        }
    }

    function doCalc(){
        refreshMinRate();
        const input = readInput();
        const miss = validateBasic(input);
        if(miss.length){
            setBadge($("statusBadge"), "信息不完整", "warn");
            $("finalRateText").textContent = "—";
            $("finalDesc").textContent = `请补齐：${miss.join("、")}。`;
            return null;
        }

        const res = calcScenario({
            ...input,
            minRate: input.minRate,
            origRate: input.origRate
        });

        // 若用户手动填写 execRate，则优先展示为最终执行（但仍保留建议）
        let execFinal = res.execRate;
        let execSource = "建议值";
        if(input.execRateManual !== null){
            execFinal = round2(input.execRateManual);
            execSource = "手动输入";
        } else {
            $("execRate").value = res.execRate; // 自动带入建议执行
        }

        // 输出 UI
        $("finalRateText").textContent = `${execFinal.toFixed(2)}%`;
        $("finalDesc").textContent = `情形：${res.caseNo}｜执行利率来源：${execSource}`;
        setBadge($("statusBadge"), "已计算", "ok");
        setBadge($("approvalBadge"), res.approvalText, res.approvalLevel);

        $("kpiOrig").textContent = input.origRate.toFixed(2) + "%";
        $("kpiMin").textContent = input.minRate.toFixed(2) + "%";
        $("kpiReprice").textContent = (res.repriceRate === null ? "—" : res.repriceRate.toFixed(2) + "%");
        $("kpiExec").textContent = execFinal.toFixed(2) + "%";

        $("processText").textContent = res.processText;

        renderChips([
            `BP换算：10BP=0.10%`,
            `情形：${res.caseNo}`,
            `addBP：${res.addBP}BP`,
            `重定价：${res.repriceRate ?? "—"}%`,
            `建议执行：${res.execRate}%`
        ]);

        drawBarChart([
            {label:"orig", value: input.origRate, show:true},
            {label:"min", value: input.minRate, show:true},
            {label:"reprice", value: res.repriceRate, show: res.repriceRate !== null},
            {label:"exec", value: execFinal, show:true},
        ]);

        return {
            input,
            res,
            execFinal
        };
    }

    function nowStr(){
        const d = new Date();
        const pad = (n)=> String(n).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function bindEvents(){
        ["product","guarantee","amount","termMonths"].forEach(id=>{
            $(id).addEventListener("change", refreshMinRate);
            $(id).addEventListener("input", refreshMinRate);
        });

        $("btnCalc").addEventListener("click", ()=>{
            doCalc();
        });

        $("btnSave").addEventListener("click", ()=>{
            const out = doCalc();
            if(!out) return;

            const {input, res, execFinal} = out;
            const record = {
                ts: nowStr(),
                product: input.product,
                guarantee: input.guarantee,
                amount: input.amount,
                termMonths: input.termMonths,
                minRate: round2(input.minRate),
                origRate: round2(input.origRate),
                overdueCount: input.overdueCount,
                fundRate: input.fundRate,
                negativeInfo: input.negativeInfo,
                caseNo: res.caseNo,
                addBP: res.addBP,
                repriceRate: res.repriceRate,
                execRate: execFinal,
                approvalText: res.approvalText,
                processText: res.processText
            };
            addHistory(record);
            renderHistoryPreview();
            alert("已保存到本机历史。");
        });

        $("btnExportCSV").addEventListener("click", exportHistoryCSV);

        $("btnClearHistory").addEventListener("click", ()=>{
            if(!confirm("确认清空本机历史？（仅清除本机浏览器存储）")) return;
            localStorage.removeItem(LS_KEY);
            renderHistoryPreview();
            alert("已清空。");
        });

        $("btnExportPNG").addEventListener("click", ()=>{
            const out = doCalc();
            if(!out) return;

            const {input, res, execFinal} = out;
            const summary = {
                ts: nowStr(),
                product: input.product,
                guarantee: input.guarantee,
                amount: input.amount,
                termMonths: input.termMonths,
                minRate: round2(input.minRate),
                origRate: round2(input.origRate),
                addBP: res.addBP,
                repriceRate: res.repriceRate,
                execRate: execFinal,
                caseNo: res.caseNo,
                approvalText: res.approvalText,
                processText: res.processText
            };
            exportResultPNG(summary);
        });
    }

    function boot(){
        initSelectors();
        refreshMinRate();
        renderHistoryPreview();
        bindEvents();
        setBadge($("statusBadge"), "等待计算", null);
        setBadge($("approvalBadge"), "—", null);
    }

    boot();
</script>
</body>
</html>
